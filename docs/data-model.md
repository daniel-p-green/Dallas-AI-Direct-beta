# Data model

## Table: `attendees`

| Column | Type | Notes |
| --- | --- | --- |
| `id` | `uuid` pk | generated by db |
| `created_at` | `timestamptz` | default `now()` |
| `name` | `text` | required |
| `email` | `text` | required, sensitive |
| `linkedin_url` | `text` | optional |
| `title` | `text` | optional |
| `company` | `text` | optional |
| `display_title_company` | `boolean` | optional, default `false` (consent flag) |
| `ai_comfort_level` | `int` | required, range `1..5` |
| `help_needed` | `text[]` | required, multi-select |
| `help_offered` | `text[]` | required, multi-select |
| `other_help_needed` | `text` | optional free text |
| `other_help_offered` | `text` | optional free text |
| `honeypot` | `text` | optional, must remain empty |
| `event_id` | `uuid` fk | optional reference to `events.id` (`on delete set null`) for event-session scoping |

## Table: `events`

| Column | Type | Notes |
| --- | --- | --- |
| `id` | `uuid` pk | generated by db |
| `slug` | `text` | unique event/session identifier |
| `name` | `text` | organizer-facing session name |
| `starts_at` | `timestamptz` | optional event start time |
| `ends_at` | `timestamptz` | optional event end time (`starts_at <= ends_at`) |
| `check_in_window_start` | `timestamptz` | optional check-in start bound |
| `check_in_window_end` | `timestamptz` | optional check-in end bound (`start <= end`) |
| `is_active` | `boolean` | active session flag; unique partial index enforces single active event |
| `metadata` | `jsonb` | extensible event metadata |
| `created_at` | `timestamptz` | default `now()` |
| `updated_at` | `timestamptz` | default `now()` |

### Event-session compatibility notes

- Existing attendee rows may keep `event_id = null` until backfilled to an explicit event.
- New event-scoped queries should include compatibility fallback (`event_id IS NULL` where needed) during migration rollout.
- Migration-level indexes support active-event lookup and event-scoped attendee reads.

## Public projection: `attendees_public`

Use `attendees_public` for directory reads.

- Include only safe public fields.
- Exclude `email`, `honeypot`, and any private notes.
- Keep UI and API contracts pinned to this view.

Recommended public fields:

- `name`
- `title` (if provided)
- `company` (if provided)
- `linkedin_url` (if enabled)
- `ai_comfort_level`
- `help_offered`

## Read/write pattern for alpha

- Inserts go to `attendees`.
- Directory reads come from `attendees_public` only.

## Match engine audit tables

### Table: `match_runs`

| Column | Type | Notes |
| --- | --- | --- |
| `id` | `uuid` pk | generated by db |
| `algorithm_version` | `text` | deterministic scoring version identifier |
| `scoring_weights` | `jsonb` | persisted weight inputs used for reproducibility |
| `run_metadata` | `jsonb` | run context (filters, source, seed metadata) |
| `generated_at` | `timestamptz` | when match scoring executed |
| `created_at` | `timestamptz` | default `now()` |
| `created_by` | `text` | optional operator/system identifier |

### Table: `attendee_matches`

| Column | Type | Notes |
| --- | --- | --- |
| `id` | `uuid` pk | generated by db |
| `run_id` | `uuid` fk | references `match_runs.id` |
| `attendee_id` | `uuid` fk | source attendee references `attendees.id` |
| `matched_attendee_id` | `uuid` fk | suggested introduction target references `attendees.id` |
| `overlap_score` | `numeric(6,4)` | `help_needed` â†” `help_offered` overlap score |
| `ai_comfort_proximity_score` | `numeric(6,4)` | distance/proximity-based comfort score |
| `recency_score` | `numeric(6,4)` | freshness bias component |
| `consent_visibility_score` | `numeric(6,4)` | consent weighting for optional title/company visibility |
| `total_score` | `numeric(6,4)` | final deterministic weighted score |
| `rank_position` | `integer` | top-N ordering per attendee/run |
| `status` | `text` | `suggested`, `approved`, `rejected` |
| `public_profile_snapshot` | `jsonb` | API-safe projection payload; no email |
| `created_at` | `timestamptz` | default `now()` |
| `updated_at` | `timestamptz` | default `now()` |
| `reviewed_at` | `timestamptz` | facilitator decision timestamp |
| `reviewed_by` | `text` | facilitator identifier |

### Table: `match_decision_events`

| Column | Type | Notes |
| --- | --- | --- |
| `id` | `uuid` pk | generated by db |
| `match_id` | `uuid` fk | references `attendee_matches.id` |
| `run_id` | `uuid` fk | references `match_runs.id` |
| `attendee_id` | `uuid` fk | references `attendees.id` |
| `matched_attendee_id` | `uuid` fk | references `attendees.id` |
| `decision` | `text` | `approved`, `rejected`, `reset` |
| `decided_by` | `text` | facilitator/system actor |
| `reason` | `text` | optional decision rationale |
| `event_metadata` | `jsonb` | audit details |
| `created_at` | `timestamptz` | default `now()` |

### Match privacy rules

- Match API/admin responses must be derived from `public_profile_snapshot` and `attendees_public`-safe fields only.
- `email` remains private in `attendees` and is never included in `attendee_matches` API-facing projections.

## Abuse/trust tables

### Table: `signup_risk_events`

| Column | Type | Notes |
| --- | --- | --- |
| `id` | `uuid` pk | generated by db |
| `request_fingerprint_hash` | `text` | hashed request fingerprint for event correlation |
| `email_hash` | `text` | hashed email identifier |
| `email_redacted` | `text` | masked email token (`***`) for analyst context |
| `ip_hash` | `text` | hashed source IP |
| `user_agent_hash` | `text` | hashed user-agent token |
| `risk_score` | `integer` | range `0..100` |
| `triggered_rules` | `text[]` | heuristics that fired |
| `event_type` | `text` | `flagged`, `rate_limited`, `blocked` |
| `malformed_payload_count` | `integer` | malformed payload count accumulator |
| `payload_shape_hash` | `text` | hashed payload-shape signature |
| `event_metadata` | `jsonb` | redacted audit details |
| `created_at` | `timestamptz` | default `now()` |
| `updated_at` | `timestamptz` | default `now()` |

### Table: `signup_moderation_queue`

| Column | Type | Notes |
| --- | --- | --- |
| `id` | `uuid` pk | generated by db |
| `risk_event_id` | `uuid` fk | references `signup_risk_events.id` |
| `request_fingerprint_hash` | `text` | same hash for queue/event joins |
| `email_hash` | `text` | hashed email identifier |
| `email_redacted` | `text` | masked email token (`***`) |
| `risk_score` | `integer` | range `0..100` |
| `triggered_rules` | `text[]` | copied detector reasons for triage |
| `status` | `text` | `pending`, `reviewing`, `resolved`, `false_positive` |
| `resolution` | `text` | optional final action |
| `resolution_notes` | `text` | optional operator notes |
| `resolved_by` | `text` | optional actor identifier |
| `resolved_at` | `timestamptz` | optional resolution timestamp |
| `created_at` | `timestamptz` | default `now()` |
| `updated_at` | `timestamptz` | default `now()` |

### Abuse/trust privacy rules

- Do not persist raw private email in moderation or risk-event tables.
- Store only `email_hash` and optional masked `email_redacted`; schema checks enforce masked format when `@` is present.
- Event correlation is done with `request_fingerprint_hash`, not raw request bodies.

## Skills used

- Scanned `~/.codex/skills` and found `antfarm-workflows/SKILL.md`.
- No Neon Postgres data-model skill exists there today.
- Applied repository data-minimization standards directly.